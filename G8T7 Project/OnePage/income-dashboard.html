<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Income Dashboard</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
  
    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  
    <!-- Vendor CSS Files -->
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
  
    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet">

    <!-- Canvas.js CDN -->
    <script src="canvasjs.min.js"></script>



</head>
<body>
  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top">
    <div class="container d-flex align-items-center justify-content-between">

      <h1 class="logo"><a href="home.html">Art House</a></h1>
      <!-- Uncomment below if you prefer to use an image logo -->
      <!-- <a href="index.html" class="logo"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto " href="#" id="products">Products</a></li>
          <li><a class="nav-link scrollto" id="productList" href="#">Live Bidding</a></li>
          <li><a class="nav-link scrollto o" href="#" id="shoppingCart">Shopping Cart</a></li>
          <li class="dropdown"><a href="#"><span>Profile</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a id="editProfile" href="#">Edit Profile</a></li>
              <li><a href="#" id="purchaseHistory">Purchase History</a></li>
              <li><a href="#" id="incomeDashboard">Income Dashboard</a></li>
              <li><a id="artistBidList" href="#">Your Bidding Products</a></li>
              <li><a href="index.html" id="btn_logout">Logout</a></li>
            </ul>
          </li>
          <li><a class="getstarted scrollto" href="#" id="createBid">Create New Bid</a></li>
          <li><a id="userName"></a></li>
          <li><a id="credits"></a></li>
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

    

  <div id="main">
         <!-- ======= Hero Section ======= -->
    <section id="hero" class="d-flex align-items-center">
      <div class="container position-relative" data-aos="fade-up" data-aos-delay="25">
        <div class="row justify-content-center">
          <div class="col-xl-12 col-lg-12 text-center">
            <h1>Sales Summary</h1>
            <br/>
            <div>
              <strong>
              Filter from 
              </strong>
              <input type="date" id="fromDate">
              <strong>
              to 
              </strong>
              <input type="date" id="toDate">
              <button id="sales" type="button" class="btn btn-primary">Get Sales</button>
            </div>
            <div id="errorAlert"></div>
            <br/><br/>
            <div id="chartContainer" style="height: 300px; width: 100%;"></div>
            <h2 id="revenue" style="color: green; font-weight: bolder">Total revenue: $</h2>
          </div>
        </div>
      </div>
    </section><!-- End Hero -->
  </div>
        
      <!-- ======= Footer ======= -->
      <footer id="footer">
    
        <div class="footer-top">
          <div class="container">
            <div class="row">
    
              <div class="col-lg-3 col-md-6 footer-contact">
                <h3>Artistic Shop</h3>
                <p>
                  A108 Adam Street <br>
                  New York, NY 535022<br>
                  United States <br><br>
                  <strong>Phone:</strong> +1 5589 55488 55<br>
                  <strong>Email:</strong> info@example.com<br>
                </p>
              </div>
    
              <div class="col-lg-2 col-md-6 footer-links">
                <h4>Useful Links</h4>
                <ul>
                  <li><i class="bx bx-chevron-right"></i> <a href="index.html">Home</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="listing.html">Products</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="#">Live Bidding</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="shoppingCart.html">Shopping Cart</a></li>
                </ul>
              </div>
    
              <div class="col-lg-3 col-md-6 footer-links">
                <h4>Our Services</h4>
                <ul>
                  <li><i class="bx bx-chevron-right"></i> <a href="#">Selling</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="#">Buying</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="#">Trading</a></li>
                  <li><i class="bx bx-chevron-right"></i> <a href="#">Bidding</a></li>
                </ul>
              </div>
    
              <div class="col-lg-4 col-md-6 footer-newsletter">
                <h4>Join Our Newsletter</h4>
                <p>Join us to receive frequent updates about priceless art pieces</p>
                <form action="" method="post">
                  <input type="email" name="email"><input type="submit" value="Subscribe">
                </form>
              </div>
    
            </div>
          </div>
        </div>
    
        <div class="container d-md-flex py-4">
    
          <div class="me-md-auto text-center text-md-start">
            <div class="copyright">
              &copy; Copyright <strong><span>Artistic Shop</span></strong>. All Rights Reserved
            </div>
          </div>
          <div class="social-links text-center text-md-right pt-3 pt-md-0">
            <a href="#" class="twitter"><i class="bx bxl-twitter"></i></a>
            <a href="#" class="facebook"><i class="bx bxl-facebook"></i></a>
            <a href="#" class="instagram"><i class="bx bxl-instagram"></i></a>
            <a href="#" class="google-plus"><i class="bx bxl-skype"></i></a>
            <a href="#" class="linkedin"><i class="bx bxl-linkedin"></i></a>
          </div>
        </div>
      </footer><!-- End Footer -->
    </div>

      <div id="preloader"></div>
      <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
    
      <!-- Vendor JS Files -->
      <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
      <script src="assets/vendor/aos/aos.js"></script>
      <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
      <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
      <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
      <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
      <script src="assets/vendor/php-email-form/validate.js"></script>
    
      <!-- Template Main JS File -->
      <script src="assets/js/main.js"></script>

      <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
        import { getAuth , createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
        import { getDatabase, get, ref, set, remove, child, onValue } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-storage.js"
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDaa4E6_70V4giloehQSPALsd247XEqH3k",
          authDomain: "ihelpartists-app.firebaseapp.com",
          databaseURL: "https://ihelpartists-app-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "ihelpartists-app",
          storageBucket: "ihelpartists-app.appspot.com",
          messagingSenderId: "1078317726292",
          appId: "1:1078317726292:web:0cadf1ec10d51359fdcbc1",
          measurementId: "G-P21FPFFWWT"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // Initialize Firebase Authentication and get a reference to the service
        const auth = getAuth(app);
        const database = getDatabase(app);
      
        //get user id from url  
          const queryString = window.location.search; 
          console.log(queryString); 
          const urlParams = new URLSearchParams(queryString); 
          console.log(urlParams); 
          const user_id = urlParams.get('user_id'); 
          console.log(user_id);
        document.getElementById('products').addEventListener('click', (e) => {  
          
          window.location.href = "listing.html?user_id=" + user_id;
        })
        
        document.getElementById('incomeDashboard').addEventListener('click', (e) => {  

          window.location.href = "income-dashboard.html?user_id=" + user_id;
        })
        
        document.getElementById('purchaseHistory').addEventListener('click', (e) => {  

          window.location.href = "purchaseHistory.html?user_id=" + user_id;
        })

        editProfile.addEventListener('click', (e) => {

          window.location.href = "Profile.html?user_id=" + user_id;
        })    

        document.getElementById('shoppingCart').addEventListener('click', (e) => {

          window.location.href = "shoppingCart.html?user_id=" + user_id;
        })

        artistBidList.addEventListener('click', (e) => {

          window.location.href = "ArtistsProductBidList.html?user_id=" + user_id;
        })

        productList.addEventListener('click', (e) => {

          window.location.href = "ProductBiddingList.html?user_id=" + user_id;
        })

        document.getElementById('createBid').addEventListener('click', (e) => {  
          
          window.location.href = "CreateBidding.html?user_id=" + user_id;
        })


        function getDefaultSales(){
            let date = new Date()
            let dateArr = []
            let incomeData = []
            let totalRevenue = 0
            var isoDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString();
            let fromDate = new Date(Date.now() - (7 * 24 * 60 * 60 * 1000))
            let toDate = new Date(Date.now())
            fromDate.setHours(0,0,0,0)
            //dayDiff converts the difference between the two dates from milliseconds to days
            let dayDiff = (toDate-fromDate) / 1000 / 60 / 60 / 24
                  //populate date array with placeholder data first
                  let indexDate = new Date(fromDate);
                  for (let d = 0; d<=dayDiff; d++){
                      dateArr.push([indexDate.toLocaleDateString('en-GB'), 0])
                      indexDate.setDate(indexDate.getDate()+1)
                  }
                  //get auction list
                  const dbRef = ref(getDatabase());
                  get(child(dbRef, `auction/`)).then((snapshot) => {
                      let auction = snapshot.val()
                      for (let aucID in auction){
                          //check if user has sold the current auction item
                          if (auction[aucID]['userId'] == user_id && auction[aucID]['lastBidUser'] != undefined && isoDateTime>auction[aucID]['countdownTimer']){
                              let soldDate = new Date(auction[aucID]['countdownTimer']);
                              soldDate.setHours(0,0,0,0);
                              if(fromDate <= soldDate && toDate >= soldDate){
                                  let currDate = new Date(fromDate);
                                  for(let d = 0; d<=dayDiff; d++){
                                      currDate.setDate(fromDate.getDate()+1)
                                      if(currDate.getDate() == soldDate.getDate()){
                                          dateArr[d][1] += parseInt(auction[aucID]['curBid'])
                                      }
                                  }
                                  
                              }
                          }
                      }
                  
                    //dateArr variable is an array which has the revenues of the current user from the date specified to the end date specified
                    for (let i=1; i<dateArr.length + 1; i++){
                      incomeData.push({x: i, y: dateArr[i-1][1], label: dateArr[i-1][0]})
                      totalRevenue += dateArr[i-1][1]
                    }
                    document.getElementById('revenue').innerText = "Total revenue: $" + totalRevenue
                    var chart = new CanvasJS.Chart("chartContainer",
                    {
                      animationEnabled: true,

                      data: [

                      {
                        dataPoints: incomeData,
                        indexLabel: "${y}",
                        indexLabelPlacement: "outside",  
                        indexLabelOrientation: "horizontal",
                      }
                      ]
                    });
                    chart.render();
                }).catch((error) => {
                console.error(error);
                });
            }
        
            var userId = "";
            var userCredit = 0;
            var userName = "";
            function getUserData(uid) {
              const db = ref(database, 'users/' + uid);
              
              onValue(db, snap => {
                  console.log(snap.val())
                  userId = uid;
                  console.log(userId);

                  userCredit = snap.val().credits;
                  userName = snap.val().firstName;
                  console.log(userCredit);
                  console.log(userName);
                  document.getElementById("credits").innerText = "Credits: SGD$" + userCredit;
                  document.getElementById("userName").innerText = "Welcome! " + userName;
              })
            }
            
            onAuthStateChanged(auth, (user) => { 
            if(user){ 
              console.log(user); 
              getUserData(user.uid) 
            }
            else{ 
              "Please try again!"; 
            } 
            })

        function getSales(){
            const alertPlaceholder = document.getElementById('errorAlert')
            const alert = (message) => {
              alertPlaceholder.innerHTML = [
                `<div class="alert alert-danger alert-dismissible" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
              ].join('')
            }
            let date = new Date()
            let dateArr = []
            let incomeData = []
            let indexLabelChecker = ""
            let totalRevenue = 0
            var isoDateTime = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString();
            let fromDate = new Date(document.getElementById('fromDate').value)
            let toDate = new Date(document.getElementById('toDate').value)
            fromDate.setHours(0,0,0,0)
            toDate.setHours(23,59,59,999)
            //dayDiff converts the difference between the two dates from milliseconds to days
            let dayDiff = (toDate-fromDate) / 1000 / 60 / 60 / 24

            if (fromDate == "Invalid Date" || toDate == "Invalid Date"){
                alert('Please select 2 dates.')
            }
            else if (dayDiff < 0){
                alert("'To' date cannot be before the 'From' date.")
            }
            else {
                //remove any alerts
                document.getElementById("errorAlert").innerHTML = ""
                
                  //populate date array with placeholder data first
                  let indexDate = new Date(fromDate);
                  for (let d = 0; d<=dayDiff; d++){
                      dateArr.push([indexDate.toLocaleDateString('en-GB'), 0])
                      indexDate.setDate(indexDate.getDate()+1)
                  }
                  //get auction list
                  const dbRef = ref(getDatabase());
                  get(child(dbRef, `auction/`)).then((snapshot) => {
                      let auction = snapshot.val()
                      for (let aucID in auction){
                          //check if user has sold the current auction item
                          if (auction[aucID]['userId'] == user_id && auction[aucID]['lastBidUser'] != undefined && isoDateTime>auction[aucID]['countdownTimer']){
                              let soldDate = new Date(auction[aucID]['countdownTimer']);
                              soldDate.setHours(0,0,0,0);
                              if(fromDate <= soldDate && toDate >= soldDate){
                                  let currDate = new Date(fromDate);
                                  for(let d = 0; d<=dayDiff; d++){
                                      currDate.setDate(fromDate.getDate()+1)
                                      if(currDate.getDate() == soldDate.getDate()){
                                          dateArr[d][1] += parseInt(auction[aucID]['curBid'])
                                      }
                                  }
                                  
                              }
                          }
                      }
                  
                    //dateArr variable is an array which has the revenues of the current user from the date specified to the end date specified
                    //console.log(dateArr)
                    for (let i=1; i<dateArr.length + 1; i++){
                      incomeData.push({x: i, y: dateArr[i-1][1], label: dateArr[i-1][0]})
                      totalRevenue += dateArr[i-1][1]
                    }
                    document.getElementById('revenue').innerText = "Total revenue: $" + totalRevenue
                    //console.log(incomeData)
                    //console.log(totalRevenue)
                    if (incomeData.length <= 31){
                      indexLabelChecker = "${y}"
                    }
                    else{
                      indexLabelChecker = ""
                    }
                    var chart = new CanvasJS.Chart("chartContainer",
                    {
                      animationEnabled: true,

                      data: [

                      {
                        dataPoints: incomeData,
                        indexLabel: indexLabelChecker,
                        indexLabelPlacement: "outside",  
                        indexLabelOrientation: "horizontal",
                      }
                      ]
                    });
                    chart.render();
                }).catch((error) => {
                console.error(error);
                });
            }
        }
    document.getElementById('sales').addEventListener('click', getSales)
    btn_logout.addEventListener('click', (e) => {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        }).catch((error) => {
          // An error happened.
          alert(error);
        });
      })
    window.onload = getDefaultSales()  
    </script>
    
</body>
</html>